# Mickey Agent 개선 사항

## 개선 1: 세션 로그 자동 생성 (2025-12-11)

### 문제
- Mickey 4가 세션 시작 시 자동으로 `MICKEY-4-SESSION.md`를 생성하지 않음
- 사용자가 물어본 후에야 로그 생성
- 작업 진행 중 실시간 기록이 안 됨

### 원인
- 초기 지시사항 준수 미흡
- 세션 시작 시 자동 로그 생성 프로세스 누락

### 개선 방안

#### 다음 Mickey (Mickey 5+)를 위한 가이드

**세션 시작 시 즉시 수행**:
```
1. 이전 Mickey 번호 확인 (MICKEY-N-SESSION.md 파일 찾기)
2. 자신의 번호 설정 (N+1)
3. MICKEY-(N+1)-SESSION.md 파일 즉시 생성
   - 기본 구조 작성
   - 세션 목표 (사용자 첫 요청 기반)
   - 이전 컨텍스트 요약
4. 작업 진행하면서 실시간 업데이트
```

**세션 로그 업데이트 타이밍**:
- 주요 작업 완료 시마다
- 문제 해결 시마다
- 중요한 결정 시마다
- 최소 30분마다 한 번

**세션 종료 시**:
- 최종 상태 업데이트
- 다음 Mickey를 위한 컨텍스트 정리
- context_rule/project-context.md 업데이트

### 체크리스트

다음 Mickey는 세션 시작 후 **첫 번째 응답 전**에:
- [ ] 이전 세션 로그 읽기
- [ ] 자신의 번호 결정
- [ ] 새 세션 로그 파일 생성
- [ ] 기본 구조 작성
- [ ] 사용자에게 세션 시작 확인

### 예시

**좋은 예 (Mickey 5 시작 시)**:
```
안녕하세요! 저는 Mickey 5입니다.

이전 세션 (Mickey 4) 확인:
- Replay Engine 및 State Validator 구현 완료
- 최종 테스트 진행 중

새 세션 로그 생성: MICKEY-5-SESSION.md ✅

무엇을 도와드릴까요?
```

**나쁜 예 (현재 Mickey 4)**:
```
안녕하세요! 저는 Mickey 4입니다.
무엇을 도와드릴까요?

(사용자가 물어본 후에야 로그 생성)
```

---

## 개선 2: 문제 해결 접근법 (2025-12-11, Mickey 4)

### Mickey 4의 실수와 교훈

#### 실수 1: 프레임 동기화 시행착오 (5번 이상 수정)
**문제**:
- 검증 타이밍을 여러 번 변경
- _process() 전 → 후 → _physics_process() → await → process_priority

**원인**:
- 로그 구조를 먼저 분석하지 않음
- 녹화와 재생의 타이밍 차이를 이해하지 못함

**교훈**:
1. **데이터 구조 먼저 분석**: 로그가 언제 기록되는지 확인
2. **타이밍 다이어그램 작성**: 녹화/재생 흐름 시각화
3. **근본 원인 파악 후 구현**: 추측으로 코드 수정 금지

#### 실수 2: Collision direction 구현 오류
**문제**:
- 모든 충돌에서 direction 변경 → Ball 이상 동작
- "다음 프레임 direction" ≠ "충돌 시 direction" 혼동

**원인**:
- 로그 데이터의 의미를 정확히 이해하지 못함
- 조건 체크 누락

**교훈**:
1. **로그 데이터 의미 파악**: 각 필드가 무엇을 나타내는지 확인
2. **조건 체크 철저히**: `is_equal_approx()` 같은 비교 함수 사용
3. **테스트 케이스 확인**: 충돌 있는 경우/없는 경우 모두 테스트

#### 실수 3: Tolerance 값 반복 조정
**문제**:
- 1.0 → 0.5 → 15.0 → 250.0 → 1.0
- 근본 원인(Delta 차이) 해결 없이 임시방편 반복

**원인**:
- 증상만 보고 원인 분석 부족
- 빠른 해결 시도

**교훈**:
1. **근본 원인 우선**: 임시방편보다 근본 해결
2. **Delta/Timestep 이해**: 물리 시뮬레이션의 기본 개념
3. **허용 오차는 마지막**: 다른 방법 모두 시도 후

---

## 개선 3: 잘한 점 (Mickey 4)

### ✅ 체계적 문제 해결
- 타입 에러 → Private 변수 → 로그 덮어쓰기 → Seed → 프레임 동기화
- 각 문제를 순차적으로 해결
- 이전 문제 해결 후 다음 문제로 진행

### ✅ 사용자 피드백 적극 반영
- "근본 해결책 필요" → Collision direction 구현
- "충돌 시점 로그 확인" → 로그 구조 분석
- 사용자 의견을 구현에 반영

### ✅ 파일 동기화 철저
- WSL ↔ Windows 파일 동기화 매번 수행
- 수정 후 즉시 복사
- 테스트 전 동기화 확인

### ✅ 상세한 문서화
- 각 문제와 해결책 기록
- 타이밍 다이어그램 작성
- 다음 Mickey를 위한 컨텍스트 정리

---

## 다음 Mickey를 위한 체크리스트

### 세션 시작 시 (첫 응답 전)
- [ ] 이전 세션 로그 읽기
- [ ] 자신의 번호 결정 (N+1)
- [ ] `MICKEY-(N+1)-SESSION.md` 즉시 생성
- [ ] 기본 구조 작성 (목표, 이전 컨텍스트, 작업 목록)
- [ ] 사용자에게 세션 시작 확인

### 문제 해결 시
- [ ] **데이터/로그 구조 먼저 분석**
- [ ] 타이밍 다이어그램 작성 (필요 시)
- [ ] 근본 원인 파악
- [ ] 최소 코드로 구현
- [ ] 테스트 (정상/비정상 케이스)
- [ ] 문서화

### 구현 시
- [ ] 조건 체크 철저히
- [ ] 타입 명시 (GDScript strict typing)
- [ ] 에러 핸들링
- [ ] 주석 작성 (왜 이렇게 했는지)

### 파일 작업 시
- [ ] WSL/Windows 동기화 확인
- [ ] 수정 후 즉시 복사
- [ ] 테스트 전 파일 확인

### 세션 종료 시
- [ ] 세션 로그 최종 업데이트
- [ ] 실수와 교훈 기록
- [ ] `context_rule/project-context.md` 업데이트
- [ ] 다음 작업 명시

---

## 개선 5: Context Window 관리 (2025-12-11, Mickey 4)

### 문제
- Context window 사용률이 50% 초과 시 관리 필요
- 세션 로그가 너무 길어지면 다음 Mickey가 읽기 어려움
- 중요 정보가 묻힐 수 있음

### 해결 방안

#### Context Window 모니터링
- **50% 초과 시**: 세션 로그 정리
- **70% 초과 시**: 새 세션 권장
- **90% 초과 시**: 즉시 새 세션 시작

#### 세션 로그 정리 방법

**1. 요약 작성**:
```markdown
## Session Completion
- 최종 성과
- 핵심 해결 과제 (3-5개)
- 파일 목록
- 다음 Mickey를 위한 요약
```

**2. 상세 내용 제거**:
- 시행착오 과정 삭제
- 중복 설명 제거
- 코드 예시 최소화

**3. 핵심만 남기기**:
- 최종 결과
- 중요한 결정
- 알려진 이슈
- 다음 작업

#### 정리 타이밍

**50% 초과 시**:
1. 현재 작업 완료
2. 세션 로그 정리
3. context_rule 업데이트
4. 계속 진행

**70% 초과 시**:
1. 현재 작업 완료
2. 세션 로그 최종 정리
3. 사용자에게 새 세션 권장
4. 핸드오프 준비

---

## 다음 Mickey 체크리스트 (업데이트)

### 세션 시작 시
- [ ] 이전 세션 로그 읽기
- [ ] 자신의 번호 결정 (N+1)
- [ ] `MICKEY-(N+1)-SESSION.md` 즉시 생성
- [ ] **Context window 사용률 확인** ⭐ 새로 추가

### 세션 진행 중
- [ ] **50% 초과 시 세션 로그 정리** ⭐ 새로 추가
- [ ] 주요 작업 완료 시마다 업데이트
- [ ] 문제 해결 시마다 기록

### 세션 종료 시
- [ ] 세션 로그 최종 정리
- [ ] **Context window 사용률 기록** ⭐ 새로 추가
- [ ] context_rule 업데이트
- [ ] 다음 작업 명시

---

## 개선 6: 사이드 이펙트 분석 필수 (2025-12-12, Mickey 5)

### 문제
- Mickey 5가 코드 수정 시 사이드 이펙트 분석 없이 즉시 파일 작성
- 기존 기능에 영향을 미칠 수 있는 변경을 사전 검증 없이 진행
- 사용자 확인 없이 수정하여 예상치 못한 문제 발생 가능

### 원인
- 빠른 문제 해결에 집중
- 영향 범위 분석 생략
- 사용자 확인 절차 누락

### 개선 방안

#### 다음 Mickey를 위한 필수 절차

**모든 코드 수정 전 필수 단계**:

1. **사이드 이펙트 분석** (5-10분)
   ```
   - 수정할 코드가 어디서 사용되는가?
   - 다른 파일/함수에서 호출하는가?
   - 변경 시 영향받는 기능은?
   - Null 체크 필요한가?
   - 타이밍 이슈 발생 가능한가?
   ```

2. **분석 결과 보고**
   ```
   ## 사이드 이펙트 분석
   
   ### 변경 내용
   - Before: ...
   - After: ...
   
   ### 영향 범위
   1. 직접 영향: ...
   2. 간접 영향: ...
   3. 잠재적 문제: ...
   
   ### 안전성 평가
   - ✅ 안전: ...
   - ⚠️ 주의: ...
   - ❌ 위험: ...
   
   ### 권장 사항
   - Option A: ...
   - Option B: ...
   ```

3. **사용자 확인**
   ```
   "사이드 이펙트 분석 완료했습니다.
   Option A로 진행하시겠습니까?"
   ```

4. **확인 후 구현**
   ```
   사용자 승인 후에만 파일 작성
   ```

---

### 예외 상황

**즉시 수정 가능한 경우**:
- ✅ 새 파일 생성 (기존 코드 영향 없음)
- ✅ 명백한 버그 수정 (오타, 문법 에러)
- ✅ 문서 작성/수정
- ✅ 주석 추가

**반드시 분석 필요한 경우**:
- ❌ 기존 함수 수정
- ❌ 함수 시그니처 변경
- ❌ 전역 변수 수정
- ❌ 노드 구조 변경
- ❌ 타이밍 관련 코드 (await, signal)
- ❌ Null 가능성 있는 코드

---

### 체크리스트

다음 Mickey는 코드 수정 전:
- [ ] 사이드 이펙트 분석 완료
- [ ] 영향 범위 파악
- [ ] 안전성 평가
- [ ] 대안 제시
- [ ] 사용자 확인
- [ ] 승인 후 구현

---

## 개선 7: 버그 발견 시 전체 코드베이스 검증 (2025-12-12, Mickey 5)

### 문제
- Mickey 5가 `start_replay()` 함수 호출 시 인자 누락 에러 발견
- 해당 함수가 다른 곳에서도 잘못 호출되었을 가능성
- 한 곳만 수정하고 다른 곳은 확인 안 함

### 원인
- 버그 발견 시 해당 위치만 수정
- 같은 패턴의 버그가 다른 곳에도 있을 가능성 간과
- 전체 코드베이스 검증 생략

### 개선 방안

#### 다음 Mickey를 위한 필수 절차

**버그나 에러 발견 시 필수 단계**:

1. **문제 패턴 파악** (2-3분)
   ```
   - 어떤 종류의 버그인가?
     * 함수 호출 에러
     * Null 참조
     * 타입 불일치
     * 로직 에러
   
   - 재현 가능한 패턴인가?
     * 같은 함수를 다른 곳에서도 호출?
     * 같은 변수를 다른 곳에서도 사용?
     * 같은 로직이 중복?
   ```

2. **전체 코드베이스 검색** (5분)
   ```bash
   # 함수 호출 검색
   grep -r "function_name(" --include="*.gd"
   
   # 변수 사용 검색
   grep -r "variable_name" --include="*.gd"
   
   # 패턴 검색
   grep -r "pattern" --include="*.gd"
   ```

3. **영향 범위 분석**
   ```
   - 같은 문제가 있는 파일 목록
   - 각 파일에서 몇 번 발생?
   - 수정 필요한 위치 정확히 파악
   ```

4. **수정 계획 보고**
   ```
   ## 버그 전파 분석
   
   ### 발견된 버그
   - 위치: file.gd:67
   - 문제: function() 인자 누락
   
   ### 같은 문제 발생 위치
   1. file1.gd:45 - function() 호출
   2. file2.gd:123 - function() 호출
   3. file3.gd:89 - function() 호출
   
   ### 수정 계획
   - [ ] file.gd:67 수정
   - [ ] file1.gd:45 수정
   - [ ] file2.gd:123 수정
   - [ ] file3.gd:89 수정
   ```

5. **사용자 확인**
   ```
   "같은 문제가 4곳에서 발견되었습니다.
   모두 수정하시겠습니까?"
   ```

6. **일괄 수정**
   ```
   확인 후 모든 위치 수정
   ```

---

### 예외 상황

**검색 불필요한 경우**:
- ✅ 명백히 한 곳에만 있는 버그 (새로 추가한 코드)
- ✅ 파일 특정적인 문제 (설정 파일 등)

**반드시 검색 필요한 경우**:
- ❌ 함수 호출 에러
- ❌ API 사용 에러
- ❌ 공통 패턴 에러
- ❌ 타입 에러

---

### 체크리스트

다음 Mickey는 버그 발견 시:
- [ ] 버그 패턴 파악
- [ ] 전체 코드베이스 검색
- [ ] 같은 문제 위치 목록화
- [ ] 수정 계획 작성
- [ ] 사용자 확인
- [ ] 일괄 수정

---

## 개선 8: (향후 추가)

...
